name: "Deploy to Firebase Hosting"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      gh-app-id:
        required: true
        type: string
      channel-id:
        required: false
        type: string
      project-id:
        required: true
        type: string
    secrets:
      gh-app-private-key:
        required: true
      firebase-service-account:
        required: true

jobs:
  build-and-deploy:
    environment: '${{ inputs.environment }}'
    runs-on: ubuntu-22.04
    steps:
      # https://github.com/marketplace/actions/checkout
      - name: Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6

      # https://github.com/marketplace/actions/mise-action
      - name: mise action
        uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd # v2.0.6

      # https://github.com/marketplace/actions/cache
      - name: Cache pub-cache
        id: cache-pub-cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        env:
          cache-name: pub-cache
        with:
          # pub-cache files are stored in `~/.pub-cache` on Linux/macOS
          path: ~/.pub-cache
          key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.cache-name }}-
            ${{ runner.os }}-

      - name: Generate gitignore target files
        run: make gen-gitignore-files

      - name: Path pub-cache
        run: echo "$HOME/.pub-cache/bin" >> "$GITHUB_PATH"

      - name: Setup Melos
        run: |
          dart pub global activate melos
          melos bootstrap

      # https://github.com/marketplace/actions/create-github-app-token
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@c8f55efbd427e7465d6da1106e7979bc8aaee856 # v1.10.1
        id: app-token
        with:
          app-id: ${{ inputs.gh-app-id }}
          private-key: ${{ secrets.gh-app-private-key }}

      # https://github.com/marketplace/actions/deploy-to-firebase-hosting
      - uses: FirebaseExtended/action-hosting-deploy@0cbcac4740c2bfb00d632f0b863b57713124eb5a # v0.9.0
        with:
          repoToken: '${{ steps.app-token.outputs.token }}'
          firebaseServiceAccount: '${{ secrets.firebase-service-account }}'
          channelId: '${{ inputs.channel-id }}'
          projectId: '${{ inputs.project-id }}'
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks